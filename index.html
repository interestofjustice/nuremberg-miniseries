// Enhanced Modal Management System
class EpisodeModalManager {
  constructor() {
    this.modal = null;
    this.modalData = null;
    this.initializeDOM();
    this.bindEvents();
  }

  initializeDOM() {
    // Create modal if not existing
    if (!document.getElementById('episode-modal')) {
      const modalHTML = `
        <div id="episode-modal" class="modal">
          <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modal-data"></div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    this.modal = document.getElementById('episode-modal');
    this.modalData = document.getElementById('modal-data');
  }

  bindEvents() {
    // Delegate event handling for efficiency
    document.addEventListener('click', (event) => {
      const episodeButton = event.target.closest('.episode-button');
      const closeButton = event.target.closest('.close-button');
      
      if (episodeButton) {
        const episodeId = episodeButton.getAttribute('data-episode');
        this.showEpisodeModal(episodeId);
      }
      
      if (closeButton || event.target === this.modal) {
        this.closeModal();
      }
    });

    // Add keyboard support for closing modal
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && this.modal.style.display === 'block') {
        this.closeModal();
      }
    });
  }

  showEpisodeModal(episodeId) {
    const data = this.getEpisodeData(episodeId);
    
    if (!data) {
      console.error('No modal data found for episode:', episodeId);
      return;
    }

    const modalContent = this.generateModalContent(data);
    
    this.modalData.innerHTML = modalContent;
    this.modal.style.display = 'block';
    
    // Accessibility and focus management
    this.modal.setAttribute('aria-hidden', 'false');
    const closeButton = this.modal.querySelector('.close-button');
    closeButton?.focus();
  }

  getEpisodeData(episodeId) {
    // Use the existing modalData object from the previous implementation
    return window.modalData?.[episodeId];
  }

  generateModalContent(data) {
    const hashtagsHTML = data.hashtags?.map(tag => 
      `<span class="hashtag">${tag}</span>`
    ).join('') || '';

    const contentListHTML = data.content?.map(item => 
      `<li>${item}</li>`
    ).join('') || '';

    return `
      <h2 class="modal-title">${data.title}</h2>
      <p class="modal-date">${data.date}</p>
      <p class="modal-description">${data.description}</p>
      ${contentListHTML ? `
        <div class="content-list-header">Content Overview:</div>
        <ul class="content-list">
          ${contentListHTML}
        </ul>
      ` : ''}
      <div class="hashtags">
        ${hashtagsHTML}
      </div>
      <div class="community-action">
        <a href="https://community.interestofjustice.org" class="community-button">Join the Community</a>
      </div>
    `;
  }

  closeModal() {
    this.modal.style.display = 'none';
    this.modal.setAttribute('aria-hidden', 'true');
    
    // Return focus to the triggering element if possible
    const lastTriggeredButton = document.querySelector('.episode-button:focus');
    lastTriggeredButton?.focus();
  }
}

// Initialize the modal manager when the DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  // Attach modalData to window to ensure it's accessible
  window.modalData = {
    // Copy the entire modalData object from the original script
    ...modalData
  };

  // Create the modal manager instance
  window.episodeModalManager = new EpisodeModalManager();

  // Additional optimizations and enhancements
  const optimizeHeights = () => {
    const container = document.querySelector('.container');
    const episodesContainer = document.querySelector('.episodes-container');
    
    if (!container || !episodesContainer) return;

    const calculateAvailableHeight = () => {
      const windowHeight = window.innerHeight;
      const headerHeight = document.querySelector('header')?.offsetHeight || 0;
      const weekSelectorHeight = document.querySelector('.week-selector')?.offsetHeight || 0;
      const padding = 40; // Additional padding

      return windowHeight - headerHeight - weekSelectorHeight - padding;
    };

    episodesContainer.style.maxHeight = `${calculateAvailableHeight()}px`;
    episodesContainer.style.overflowY = 'auto';
  };

  // Run on initial load and window resize
  optimizeHeights();
  window.addEventListener('resize', optimizeHeights);
});

// Performance and accessibility enhancements
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    // Cleanup when page is not visible
    window.episodeModalManager?.closeModal();
  }
});
